<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>AKARI Install manual</title>
<link rel="stylesheet" href="http://akari.sourceforge.jp/akari.css" media="all" type="text/css">
</head>
<body>
<p style="text-align:right;"><a href="enforcing.html.ja">Japanese Page</a></p>
<p style="text-align:right;">Last modified: $Date$</p>
<h1>Phase 5: Restricting your system's behavior.</h1>

<p>This page describes how to use AKARI's enforcing mode and how to handle policy violations which arises in enforcing mode.</p>

<hr>

<h2><a name="using_enforcing_mode">Step 1: Enabling enforcing mode</a></h2>

<p>After you came to think you have done everything, run the policy editor and change the profile number to 3.</p>

<p>Run the policy editor. Choose target domains and press 's' key and enter '3' and press 'Enter' key.</p>

<p><img src="editpolicy-httpd-set-profile3.png" width="720" height="400"></p>

<p>Now the profile number of the /usr/sbin/httpd and descendant has changed to 3.</p>

<p><img src="editpolicy-httpd-profile3.png" width="720" height="400"></p>

<p>Press '@' key to switch to process list. Verify that /usr/sbin/httpd processes and descendant are assigned profile number 3.</p>

<p><img src="editpolicy-httpd-process3.png" width="720" height="400"></p>

<p>And now, /usr/sbin/httpd processes and descendant are protected by MAC, for the profile 3 was configured for enforcing mode.</p>

<p><img src="editpolicy-profile-list-enforcing.png" width="720" height="400"></p>

<p>Press 'q' key to quit the policy editor.</p>

<p>Let's try an operation which is permitted by policy.</p>

<p><img src="operation-permitted.png" width="684" height="912"></p>

<p>The operation was successfully completed, for sending mail is permitted by policy.</p>

<p>Let's try an operation which is not permitted by policy.</p>

<p><img src="unix-penguin.png" width="684" height="912"></p>

<p>The operation was rejected. (Seemingly, it looks like it was successfully completed. But actually, the execution of /bin/cat was rejected as you can see warning message by /bin/mail that the input was empty.)</p>

<p><img src="unix-penguin-rejected.png" width="684" height="597"></p>

<p>If the profile is configured as "PREFERENCE::enforcing={ verbose=yes }" (this is default), the "ERROR:" messages will be printed to the console when policy violation occurs.</p>

<p><img src="enforcing-error.png" width="720" height="400"></p>

<p>If you have configured audit logs at <a href="initialize.html.en#configure_audit_daemon">Phase 2: Initializing configuration.</a>, you can pick up rejected requests from audit logs using "grep".</p>

<table border="1">
<tr><td>
[root@akari ~]# grep -A 3 -F 'profile=3 mode=enforcing' /var/log/ccs/reject_log.conf<br>
#2010-09-09 20:43:43# profile=3 mode=enforcing (global-pid=3176) task={ pid=3176 ppid=3175 uid=48 gid=48 euid=48 egid=48 suid=48 sgid=48 fsuid=48 fsgid=48 } path1={ uid=0 gid=0 ino=852009 major=8 minor=1 perm=0755 type=file } path1.parent={ uid=0 gid=0 ino=851969 perm=0755 } exec={ realpath="/bin/cat" argc=2 envc=15 argv[]={ "cat" "/etc/passwd" } envp[]={ "SELINUX_INIT=YES" "CONSOLE=/dev/console" "TERM=linux" "INIT_VERSION=sysvinit-2.86" "PATH=/sbin:/usr/sbin:/bin:/usr/bin" "_=/bin/cat" "RUNLEVEL=3" "runlevel=3" "PWD=/usr/share/horde/admin" "LANG=en_US.UTF-8" "PREVLEVEL=N" "previous=N" "HOME=/" "SHLVL=4" "LANGUAGE=en_US.UTF-8" } }<br>
&lt;kernel&gt; /usr/sbin/httpd /bin/sh<br>
file execute /bin/cat<br>
<br>
#2010-09-09 20:43:43# profile=3 mode=enforcing (global-pid=3176) task={ pid=3176 ppid=3175 uid=48 gid=48 euid=48 egid=48 suid=48 sgid=48 fsuid=48 fsgid=48 } path1={ uid=0 gid=0 ino=852009 major=8 minor=1 perm=0755 type=file } path1.parent={ uid=0 gid=0 ino=851969 perm=0755 }<br>
&lt;kernel&gt; /usr/sbin/httpd /bin/sh<br>
file read /bin/cat
</td></tr>
</table>

<p>The first log reports that execution of /bin/cat was requested by /bin/sh which was invoked by /usr/sbin/httpd , and the command line argument was "cat /etc/passwd". As its first line has "mode=enforcing", this request was rejected.</p>

<p>The second log reports that opening /bin/cat for reading requested by /bin/sh which was invoked by /usr/sbin/httpd was rejected. This is because that /bin/sh tries to open the requested program for reading when that program was not executed.</p>

<p>AKARI can report the occurrence of policy violation in enforcing mode, if you have set up a mean to notify (e.g. mail). You can use cron daemon for notifying. For example, to notify root@example.com via mail, once per an hour, add</p>

<table border="1">
<tr><td>
00 * * * * root /usr/lib/akari/ccs-notifyd 0 'mail root@example.com'
</td></tr>
</table>

<p>to /etc/crontab . If you have configured like above, you will receive mails like below. The content of mail is identical to the audit logs, except that it has serial numbers in the header.</p>

<table border="1">
<tr><td>
[root@akari ~]# mail<br>
Mail version 8.1 6/6/93.  Type ? for help.<br>
"/var/spool/mail/root": 1 message 1 unread<br>
&gt;U  1 root@localhost.local  Thu Sep  9 20:43  19/1335<br>
&amp;<br>
Message 1:<br>
From root@localhost.localdomain  Thu Sep  9 20:43:43 2010<br>
Date: Thu, 9 Sep 2010 20:43:43 +0900<br>
From: root &lt;root@localhost.localdomain&gt;<br>
To: root@localhost.localdomain<br>
<br>
Q0-0<br>
#2010-09-09 20:43:43# profile=3 mode=enforcing (global-pid=3176) task={ pid=3176 ppid=3175 uid=48 gid=48 euid=48 egid=48 suid=48 sgid=48 fsuid=48 fsgid=48 } path1={ uid=0 gid=0 ino=852009 major=8 minor=1 perm=0755 type=file } path1.parent={ uid=0 gid=0 ino=851969 perm=0755 } exec={ realpath="/bin/cat" argc=2 envc=15 argv[]={ "cat" "/etc/passwd" } envp[]={ "SELINUX_INIT=YES" "CONSOLE=/dev/console" "TERM=linux" "INIT_VERSION=sysvinit-2.86" "PATH=/sbin:/usr/sbin:/bin:/usr/bin" "_=/bin/cat" "RUNLEVEL=3" "runlevel=3" "PWD=/usr/share/horde/admin" "LANG=en_US.UTF-8" "PREVLEVEL=N" "previous=N" "HOME=/" "SHLVL=4" "LANGUAGE=en_US.UTF-8" } }<br>
&lt;kernel&gt; /usr/sbin/httpd /bin/sh<br>
file execute /bin/cat
</td></tr>
</table>

<p>If the profile is configured as "PREFERENCE::enforcing={ penalty=1 }", you can make the process which violated policy in enforcing mode sleep for 0.1 second. This feature is useful for avoiding that the CPU usage remains 100% when policy violation occurs in an infinite loop. Below video demonstrates a hijacked Samba server process is consuming CPU by repeating request that is not permitted by policy.<br>
<object width="425" height="344"><param name="movie" value="http://www.youtube.com/v/7OE-ySG8fME&amp;hl=en_US&amp;fs=1"></param><param name="allowFullScreen" value="true"></param><param name="allowscriptaccess" value="always"></param><embed src="http://www.youtube.com/v/7OE-ySG8fME&amp;hl=en_US&amp;fs=1" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="425" height="344"></embed></object></p>

<hr>

<h2><a name="using_interactive_mode">Step 2: Handling policy violation arising in during software updates</a></h2>

<p>Since the behavior of the system is restricted by policy, you may need to update policy when you update packages.</p>

<p>You need to update policy in the following cases.</p>

<ul>
<li>The pathname of files has changed.
<li>The dependency of files has changed.
<li>The access permissions required has increased.
</ul>

<p>The ideal way to update policy is to rebuild from the scratch using learning mode. But it is not desirable to change from enforcing mode to other mode if the system has once entered in production state. Suppose MAC could support per-application enforcing mode, the MAC becomes useless if an application that is not running in enforcing mode was cracked. For example, the whole system becomes vulnerable if only HTTP server application is running in learning mode to rebuild policy for the application. So, in AKARI, updating policy is done while the system is running in enforcing mode.</p>

<p>AKARI includes tools that help administrators update policy while the system is running in enforcing mode. By using these tools, you can continue running the system without rebuilding from the scratch using learning mode if the modification is trivial. But note that these tools cannot always support every cases and the result of updated policy is not always the optimized.</p>

<h3>Operation example</h3>

<p>Below video demonstrates operation example.<br>
<object width="425" height="344"><param name="movie" value="http://www.youtube.com/v/b9q1Jo25LPA&amp;hl=en_US&amp;fs=1"></param><param name="allowFullScreen" value="true"></param><param name="allowscriptaccess" value="always"></param><embed src="http://www.youtube.com/v/b9q1Jo25LPA&amp;hl=en_US&amp;fs=1" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="425" height="344"></embed></object></p>

<table border="1">
<tr><td>
[root@akari ~]# /usr/sbin/ccs-queryd<br>
Monitoring /proc/ccs/query . Press Ctrl-C to terminate.<br>
<br>
#2010-01-10 12:27:10# profile=3 mode=enforcing (global-pid=4210) task={ pid=4210 ppid=4205 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0 } path1={ uid=0 gid=0 ino=1766 major=0 minor=17 perm=0666 type=char dev_major=1 dev_minor=3 } path1.parent={ uid=0 gid=0 ino=962 perm=0755 }<br>
&lt;kernel&gt; /etc/rc.d/init.d/sshd<br>
file ioctl /dev/null 0x5401<br>
Allow? ('Y'es/'N'o/'R'etry/'S'how policy/'A'dd to policy and retry):s<br>
# select global-pid=4210<br>
&lt;kernel&gt; /etc/rc.d/init.d/sshd<br>
use_profile 3<br>
<br>
file read /bin/bash<br>
file read/write /dev/tty<br>
file read/write /dev/pts/\$<br>
file read /usr/lib/locale/locale-archive<br>
file read /etc/nsswitch.conf<br>
file read /etc/passwd<br>
file read /etc/rc.d/init.d/sshd<br>
file read /etc/rc.d/init.d/functions<br>
file execute /sbin/consoletype exec.realpath="/sbin/consoletype" exec.argv[0]="/sbin/consoletype"<br>
file read /etc/profile.d/lang.sh<br>
file read /etc/sysconfig/i18n<br>
file read /etc/sysconfig/init<br>
file execute /sbin/runlevel exec.realpath="/sbin/runlevel" exec.argv[0]="runlevel"<br>
file execute /bin/cp exec.realpath="/bin/cp" exec.argv[0]="cp"<br>
file execute /usr/sbin/sshd exec.realpath="/usr/sbin/sshd" exec.argv[0]="/usr/sbin/sshd"<br>
file execute /bin/touch exec.realpath="/bin/touch" exec.argv[0]="touch"<br>
file read/write /dev/console<br>
file execute /bin/unicode_start exec.realpath="/bin/unicode_start" exec.argv[0]="/bin/unicode_start"<br>
file read /var/run/sshd.pid<br>
file write /dev/null<br>
file execute /bin/usleep exec.realpath="/bin/usleep" exec.argv[0]="usleep"<br>
file execute /bin/rm exec.realpath="/bin/rm" exec.argv[0]="rm"<br>
file execute /usr/bin/killall exec.realpath="/usr/bin/killall" exec.argv[0]="killall"<br>
file execute /usr/bin/rhgb-client exec.realpath="/usr/bin/rhgb-client" exec.argv[0]="/usr/bin/rhgb-client"<br>
file execute /bin/sleep exec.realpath="/bin/sleep" exec.argv[0]="sleep"<br>
file ioctl /dev/console 0x5401<br>
file ioctl /etc/rc.d/init.d/sshd 0x5401<br>
file ioctl /var/run/sshd.pid 0x5401<br>
file ioctl /dev/pts/\$ 0x5401<br>
<br>
<br>
#2010-01-10 12:27:20# profile=3 mode=enforcing (global-pid=4210) task={ pid=4210 ppid=4205 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0 } path1={ uid=0 gid=0 ino=1766 major=0 minor=17 perm=0666 type=char dev_major=1 dev_minor=3 } path1.parent={ uid=0 gid=0 ino=962 perm=0755 }<br>
&lt;kernel&gt; /etc/rc.d/init.d/sshd<br>
file ioctl /dev/null 0x5401<br>
Allow? ('Y'es/'N'o/'R'etry/'S'how policy/'A'dd to policy and retry):a<br>
Enter new entry&gt; file ioctl /dev/null 0x5401<br>
Added 'file ioctl /dev/null 0x5401'.<br>
<br>
----------------------------------------<br>
#2010-01-10 12:29:35# profile=3 mode=enforcing (global-pid=4561) task={ pid=4561 ppid=4557 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0 } path1={ uid=0 gid=0 ino=1507379 major=8 minor=1 perm=0755 type=file } path1.parent={ uid=0 gid=0 ino=1507329 perm=0755 } exec={ realpath="/bin/sleep" argc=2 envc=6 argv[]={ "sleep" "1" } envp[]={ "TERM=xterm" "PATH=/sbin:/usr/sbin:/bin:/usr/bin" "PWD=/" "LANG=en_US.UTF-8" "SHLVL=1" "_=/bin/sleep" } }<br>
&lt;kernel&gt; /etc/rc.d/init.d/cups<br>
file execute /bin/sleep<br>
Allow? ('Y'es/'N'o/'R'etry/'S'how policy/'A'dd to policy and retry):a<br>
Enter new entry&gt; file execute /bin/sleep exec.argc=2 exec.argv[1]="1"<br>
Added 'file execute /bin/sleep exec.argc=2 exec.argv[1]="1"'.<br>
<br>
#2010-01-10 12:29:58# profile=3 mode=enforcing (global-pid=4561) task={ pid=4561 ppid=4557 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0 } path1={ uid=0 gid=0 ino=707247 major=8 minor=1 perm=0644 type=file } path1.parent={ uid=0 gid=0 ino=688142 perm=0755 }<br>
&lt;kernel&gt; /etc/rc.d/init.d/cups /bin/sleep<br>
file read /usr/lib/locale/locale-archive<br>
Allow? ('Y'es/'N'o/'R'etry/'S'how policy/'A'dd to policy and retry):a<br>
Enter new entry&gt; file read /usr/lib/locale/locale-archive<br>
Added 'file read /usr/lib/locale/locale-archive'.<br>
<br>
----------------------------------------<br>
#2010-01-10 12:30:10# profile=3 mode=enforcing (global-pid=4630) task={ pid=4630 ppid=4629 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0 } path1={ uid=0 gid=0 ino=955698 major=8 minor=1 perm=0666 type=socket } path1.parent={ uid=0 gid=0 ino=950312 perm=0755 }<br>
&lt;kernel&gt; /usr/sbin/acpid<br>
file unlink /var/run/acpid.socket<br>
Allow? ('Y'es/'N'o/'R'etry/'S'how policy/'A'dd to policy and retry):a<br>
Enter new entry&gt; file unlink /var/run/acpid.socket path1.type=socket<br>
Added 'file unlink /var/run/acpid.socket path1.type=socket'.
</td></tr>
</table>

<p>Policy violation might occur while updating packages due to unusual behavior such as restarting daemons. When a policy violation occurs, a prompt appears in the "ccs-queryd". The lines</p>

<table border="1">
<tr><td>
#2010-01-10 12:29:35# profile=3 mode=enforcing (global-pid=4561) task={ pid=4561 ppid=4557 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0 } path1={ uid=0 gid=0 ino=1507379 major=8 minor=1 perm=0755 type=file } path1.parent={ uid=0 gid=0 ino=1507329 perm=0755 } exec={ realpath="/bin/sleep" argc=2 envc=6 argv[]={ "sleep" "1" } envp[]={ "TERM=xterm" "PATH=/sbin:/usr/sbin:/bin:/usr/bin" "PWD=/" "LANG=en_US.UTF-8" "SHLVL=1" "_=/bin/sleep" } }<br>
&lt;kernel&gt; /etc/rc.d/init.d/cups<br>
file execute /bin/sleep<br>
Allow? ('Y'es/'N'o/'R'etry/'S'how policy/'A'dd to policy and retry):
</td></tr>
</table>

<p>indicates that a process which belongs to the domain "&lt;kernel&gt; /etc/rc.d/init.d/cups" attempted to execute /bin/sleep in order to process the commandline "sleep 1" but the attempt was denied by policy, and the kernel is asking for your decision.
Validate whether or not to permit the request and tell the kernel your decision. You can press "Y" to grant the request. You can press "N" to reject the request. You can press "R" to retry the request. You can press "S" to show domain policy for the process. You can press "A" to edit and append to domain policy and then retry the request.</p>

<p>Never grant access requests unconditionally. The cause of policy violation is not always updating packages, but may be malicious requests by attackers. If you grant access requests caused by malicious requests by attackers, the system gets intruded.</p>

<p>If "ccs-queryd" is running, the access requests that violated policy are kept pending. To avoid sleeping forever because of pending access requests, never logout (for example, detaching from screen(1)) while "ccs-queryd" is running.</p>

<p>Do a series of operations to confirm that programs that are protected by MAC can run properly. If some access permissions are missing, the messages will be printed to "ccs-queryd", so don't forget to monitor "ccs-queryd".</p>

<p>Note that "ccs-queryd" directly edits the policy currently loaded into the kernel. Thus, the changes made by "ccs-queryd" are lost by the system's shutdown. Be sure to run "ccs-savepolicy" to save the latest policy.</p>

<table border="1">
<tr><td>
[root@akari ~]# /usr/sbin/ccs-savepolicy
</td></tr>
</table>

<p>You have finished updating policies. Close the console or terminal you executed "ccs-queryd".</p>

<hr>

<p><a href="index.html.en">Return to index page.</a></p>
<p><a href="http://sourceforge.jp/"><img src="http://sourceforge.jp/sflogo.php?group_id=1973" width="96" height="31" alt="SourceForge.jp"></a></p>
</body>
</html>
