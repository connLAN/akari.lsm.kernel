<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ja-JP">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>AKARI 導入手順書</title>
<link rel="stylesheet" href="http://tomoyo.sourceforge.jp/tomoyo.css" media="all" type="text/css">
</head>
<body>
<p style="text-align:right;"><a href="phase-3.html.en">English Page</a></p>
<p style="text-align:right;">Last modified: $Date$</p>
<h1>第３節：ドメインを解析する</h1>

<p style="text-align:center;">目的：「学習モード」の使い方を習得し、それをドメインを解析するために利用します。</p>

<hr>

<h2><a name="3.1">ステップ３．１：ドメインを作成する</a></h2>

<p>それぞれのドメインは異なる振る舞いをするので、それぞれのドメインの振る舞いに適合したアクセス許可を必要とします。そのため、あなたが許可すべきアクセス許可を決める上で、ドメインの振る舞いを解析することが必要になります。 AKARI は特定のドメインだけをアクセス制限の対象とすることもできます、しかし、最も安全なシステムにするためには、脆弱なままのドメインを残さないようにするために全てのドメインをアクセス制限の対象とすることが望まれるでしょう。</p>

<p>最初に、どのアプリケーションを解析／保護の対象とするかを決めてください。以下の手順は CentOS 5.6 環境で Apache を保護する場合で説明します。</p>

<p>対象となるアプリケーションを開始させます。</p>

<table border="1">
<tr><td>
[root@tomoyo ~]# service httpd start
</td></tr>
</table>

<p>今回は現在カーネル内に存在しているポリシーを直接編集するので、 /etc/ccs/ オプションを指定しないでポリシーエディタを実行してください。既にポリシーエディタを実行中であれば、 Domain Transition 画面に切り替えてください。</p>

<p>CentOS 5.6 では、 Apache プログラムパス名は /usr/sbin/httpd です。</p>

<p>矢印キーや Home/End/PageUp/PageDown キーを使ってカーソルをスクロールして、 /usr/sbin/httpd の行を見つけてください。この絵では 386 行目です。</p>

<p><img src="editpolicy-httpd-profile0.png" alt="editpolicy-httpd-profile0.png" width="720" height="400"></p>

<p>もし、 /usr/sbin/httpd が &lt;kernel&gt; /usr/sbin/mingetty /bin/login /bin/bash ドメインから起動された場合、 <b>&lt;kernel&gt; /usr/sbin/mingetty /bin/login /bin/bash /usr/sbin/httpd</b> という名前のドメインが作成されます。</p>

<p>もし、 /usr/sbin/httpd が initialize_domain キーワードで指定されていた場合、 /usr/sbin/httpd を起動したドメインとは無関係に <b>&lt;kernel&gt; /usr/sbin/httpd</b> という名前のドメインが作成されます。この手順書では /usr/sbin/httpd が initialize_domain に指定されている場合で説明します。詳細については<a href="tool-editpolicy.html.ja#Initialize_domain_transition">ドメイン遷移を初期化する方法について</a>を参照してください。</p>

<p>s キーを押してから 1 と入力し、 Enter キーを押してください。</p>

<p><img src="editpolicy-httpd-set-profile1.png" alt="editpolicy-httpd-set-profile1.png" width="720" height="400"></p>

<p>/usr/sbin/httpd のプロファイル番号が 1 に変化しました。</p>

<p><img src="editpolicy-httpd-profile1.png" alt="editpolicy-httpd-profile1.png" width="720" height="400"></p>

<p>@ キーを押してプロセス一覧表示に切り替えてください。そして、 /usr/sbin/httpd プロセスに対してプロファイル 1 が割り当てられていることを確認してください。</p>

<p><img src="editpolicy-httpd-process1.png" alt="editpolicy-httpd-process1.png" width="720" height="400"></p>

<p>q キーを押してポリシーエディタを終了してください。</p>

<hr>

<h2><a name="3.2">ステップ３．２：必要なアクセス許可を収集する</a></h2>

<p>Apache の起動時／終了時に必要となるアクセス許可を学習させるために、 Apache を再起動します。</p>

<table border="1">
<tr><td>
[root@tomoyo ~]# service httpd restart
</td></tr>
</table>

<p>ポリシーエディタを実行し、 /usr/sbin/httpd の行へ移動してください。（あなたやシステムが実行したプログラムによりドメインが追加されることで、行番号が変化しているかもしれません。）</p>

<p>Enter キーを押すと、現在までに収集されたアクセス許可が表示されます。</p>

<p><a href="editpolicy-httpd-full.png">（クリックすると全体を表示します。）<br><img src="editpolicy-httpd-acl1.png" alt="editpolicy-httpd-acl1.png" width="720" height="400"></a></p>

<p>ポリシーエディタを終了し、 Apache が通常の使い方をするのに必要なアクセス許可を生成するために、 Apache に対して許可したい操作を全て行ってください。</p>

<p><img src="operation-learning.png" alt="operation-learning.png" width="689" height="907"></p>

<p>収集されたアクセス許可はカーネル内のメモリにしか存在しないため、時々ポリシーファイルとしてディスク上に保存することを忘れないでください。システムを再起動した場合、カーネル内のメモリに存在しているアクセス許可は失われます。</p>

<p>現在カーネル内のメモリに存在しているポリシーをディスク上に保存するには、以下のコマンドを実行します。</p>

<table border="1">
<tr><td>
[root@tomoyo ~]# /usr/sbin/ccs-savepolicy
</td></tr>
</table>

<p>ccs-savepolicy コマンドを実行することにより、４個のファイル（ exception_policy.conf domain_policy.conf profile.conf manager.conf ）が /etc/ccs/ ディレクトリ内に作成されます。より正確に言うと、これらは作成時刻をパス名の中に含んだ通常ファイルへのシンボリックリンクとして作成されます。</p>

<p>ディスク上に保存されているポリシーをカーネル内のメモリに読み込ませるには、 ccs-loadpolicy コマンドを利用します。</p>

<table border="1">
<tr><td>
[root@tomoyo ~]# /usr/sbin/ccs-loadpolicy -df &lt; /etc/ccs/domain_policy.conf<br>
[root@tomoyo ~]# /usr/sbin/ccs-loadpolicy -ef &lt; /etc/ccs/exception_policy.conf<br>
[root@tomoyo ~]# /usr/sbin/ccs-loadpolicy -p &lt; /etc/ccs/profile.conf<br>
[root@tomoyo ~]# /usr/sbin/ccs-loadpolicy -m &lt; /etc/ccs/manager.conf<br>
</td></tr>
</table>

<p><b>-df</b> オプションは /proc/ccs/domain_policy を上書きします。<br>
<b>-ef</b> オプションは /proc/ccs/exception_policy を上書きします。<br>
<b>-p</b> オプションは /proc/ccs/profile に追記します。<br>
<b>-m</b> オプションは /proc/ccs/manager に追記します。</p>

<p>致命的な操作ミスを防ぐために、 -pf および -mf というオプションはサポートされていません。</p>

<p>コンソール上に以下のようなメッセージが表示される場合があります。</p>

<table border="1">
<tr><td>
WARNING: Domain '&lt;kernel&gt; /usr/sbin/httpd' has too many ACLs to hold. Stopped learning mode.
</td></tr>
</table>

<p>これは、 AKARI が全てのメモリを消費してしまうのを予防するための安全装置です。もし、学習モードに対して制限が存在しない場合、学習モードにより学習されたポリシーとの比較処理のために使い物にならないくらい応答が遅くなってしまうかもしれません。</p>

<p>この制限はプロファイルの max_learning_entry の値を増やすことで緩めることができます。しかし、 max_learning_entry の値を増やすとメモリ消費が増えるため、注意が必要です。 max_learning_entry の値を増やす前に、ポリシーのチューニングを行ってください。チューニングを行う手順は次節で紹介します。ポリシーのチューニングを行うことで、ドメインポリシーの量を減らして管理しやすくなり、 max_learning_entry の値を増やす必要性も解消できることが期待されます。</p>

<br>

<div class=navfooter>
<hr align="left" width="100%">
<table summary="Footer navigation table" width="100%" border="0" cellpadding="0" cellspacing="0">
<tr>
<td width="33%" align="left" valign="top">
<a href="phase-2.html.ja">前節</a>
</td>
<td width="34%" align="center" valign="top">
<a href="index.html.ja">目次</a>
</td>
<td width="33%" align="right" valign="top">
<a href="phase-4.html.ja">次節</a>
</td></tr>
<tr><td width="33%" align="left" valign="top">
第２節： AKARI を理解する
</td>
<td width="34%" align="center" valign="top">
<a href="http://tomoyo.sourceforge.jp/">ホーム</a>
</td>
<td width="33%" align="right" valign="top">
第４節：ポリシーを作成する
</td>
</tr>
</table>
</div>

<p><a href="http://sourceforge.jp/"><img src="http://sourceforge.jp/sflogo.php?group_id=5310" width="96" height="31" alt="SourceForge.jp"></a></p>
</body>
</html>
